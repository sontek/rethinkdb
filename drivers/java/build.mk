# Copyright 2010-2015 RethinkDB

JAVA_SRC_DIR=$(TOP)/drivers/java
JAVA_BUILD_DIR=$(TOP)/build/drivers/java
JAVA_PKG_DIR=$(TOP)/build/package/java

METAJAVA=$(JAVA_SRC_DIR)/metajava.py

PACKAGE_DIR=$(JAVA_SRC_DIR)/src/main/java/com/rethinkdb
TEMPLATE_DIR=$(JAVA_SRC_DIR)/templates
PROTO_DIR=$(PACKAGE_DIR)/proto
AST_GEN_DIR=$(PACKAGE_DIR)/ast/gen
MODEL_DIR=$(PACKAGE_DIR)/model
PROTO_FILE=$(TOP)/src/rdb_protocol/ql2.proto
PROTO_JSON=$(JAVA_SRC_DIR)/proto_basic.json
TERM_INFO=$(JAVA_SRC_DIR)/term_info.json
JAVA_TERM_INFO=$(JAVA_BUILD_DIR)/java_term_info.json
GLOBAL_INFO=$(JAVA_SRC_DIR)/global_info.json

.PHONY: java-driver
java-driver: gradle | $(JAVA_BUILD_DIR)/.

$(JAVA_BUILD_DIR):
	$P MKDIR $@
	mkdir -p $@

$(PROTO_JSON): $(PROTO_FILE)
	$P CONVERT PROTOFILE
	$(PYTHON) $(JAVA_SRC_DIR)/convert_protofile.py $(PROTO_FILE) $(PROTO_JSON)

$(TERM_INFO): $(PROTO_JSON)
	$P UPDATING $(notdir $@)
	$(PYTHON) $(METAJAVA) update-terminfo \
		--term-info=$(TERM_INFO) \
		--proto-json=$(PROTO_JSON)

$(JAVA_TERM_INFO): $(TERM_INFO) | $(JAVA_BUILD_DIR)/.
	$P GENERATING JAVA TERM INFO
	$(PYTHON) $(METAJAVA) generate-java-terminfo \
		--term-info=$(TERM_INFO) \
		--output-file=$@

.PHONY: autogenerated-classes
autogenerated-classes: $(JAVA_TERM_INFO)
	$P GENERATING JAVA CLASSES
	$(PYTHON) $(METAJAVA) generate-java-classes \
		--global-info=$(GLOBAL_INFO) \
		--java-term-info=$(JAVA_TERM_INFO)

.PHONY: gradle
gradle: autogenerated-classes
	$P GRADLE COMPILING JAVA DRIVER
	gradle build
