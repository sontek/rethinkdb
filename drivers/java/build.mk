# Copyright 2010-2015 RethinkDB

JAVA_SRC_DIR=$(TOP)/drivers/java
JAVA_BUILD_DIR=$(TOP)/build/drivers/java
JAVA_PKG_DIR=$(TOP)/build/package/java

PACKAGE_DIR=$(JAVA_SRC_DIR)/src/main/java/com/rethinkdb

GEN_DIR=$(PACKAGE_DIR)/gen
PROTO_DIR=$(GEN_DIR)/proto
AST_DIR=$(GEN_DIR)/ast
MODEL_DIR=$(GEN_DIR)/model
EXC_DIR=$(GEN_DIR)/exc

METAJAVA=$(JAVA_SRC_DIR)/metajava.py
CONVERT_PROTO=$(JAVA_SRC_DIR)/convert_protofile.py

TEMPLATE_DIR=$(JAVA_SRC_DIR)/templates
PROTO_FILE=$(TOP)/src/rdb_protocol/ql2.proto
PROTO_JSON=$(JAVA_SRC_DIR)/proto_basic.json
TERM_INFO=$(JAVA_SRC_DIR)/term_info.json
JAVA_TERM_INFO=$(JAVA_BUILD_DIR)/java_term_info.json
GLOBAL_INFO=$(JAVA_SRC_DIR)/global_info.json

.PHONY: java-driver
java-driver: autogenerated-classes | $(JAVA_BUILD_DIR)/.
	$P GRADLE COMPILING JAVA DRIVER
	gradle build

$(JAVA_BUILD_DIR) $(GEN_DIR) $(PROTO_DIR) $(AST_DIR) $(EXC_DIR) $(MODEL_DIR):
	$P MKDIR $@
	mkdir -p $@

$(PROTO_JSON): $(PROTO_FILE) $(CONVERT_PROTO)
	$P CONVERT PROTOFILE
	$(PYTHON) $(CONVERT_PROTO) $(PROTO_FILE) $(PROTO_JSON)

$(TERM_INFO): $(PROTO_JSON) $(METAJAVA)
	$P UPDATING $(notdir $@)
	$(PYTHON) $(METAJAVA) update-terminfo	\
		--term-info=$(TERM_INFO)	\
		--proto-json=$(PROTO_JSON)

$(JAVA_TERM_INFO): $(TERM_INFO) $(METAJAVA) | $(JAVA_BUILD_DIR)/.
	$P GENERATING JAVA TERM INFO
	$(PYTHON) $(METAJAVA) generate-java-terminfo	\
		--term-info=$(TERM_INFO)		\
		--output-file=$@

.PHONY: autogenerated-classes
autogenerated-classes: $(JAVA_TERM_INFO) $(GLOBAL_INFO) $(METAJAVA) \
	| $(MODEL_DIR) $(AST_DIR) $(PROTO_DIR) $(EXC_DIR)
	$P GENERATING JAVA CLASSES
	$(PYTHON) $(METAJAVA) generate-java-classes	\
		--global-info=$(GLOBAL_INFO)		\
		--proto-json=$(PROTO_JSON)		\
		--java-term-info=$(JAVA_TERM_INFO)	\
		--template-dir=$(TEMPLATE_DIR)		\
		--package-dir=$(PACKAGE_DIR)
